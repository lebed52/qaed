# 📸 Визуальное регрессионное тестирование (Visual Regression Testing)

## 🎯 Что это такое?

Визуальное регрессионное тестирование автоматически сравнивает скриншоты с эталонными (baseline) изображениями, чтобы обнаружить нежелательные визуальные изменения.

## 🔄 Как это работает?

```
┌─────────────────────────────────────────────────────────────┐
│  1️⃣ ПЕРВЫЙ ЗАПУСК (создание эталонов)                      │
├─────────────────────────────────────────────────────────────┤
│  npx playwright test --update-snapshots                     │
│                                                              │
│  → Создаются эталонные скриншоты (baseline)                │
│  → Сохраняются в tests/*.spec.ts-snapshots/                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  2️⃣ ПОСЛЕДУЮЩИЕ ЗАПУСКИ (проверка)                         │
├─────────────────────────────────────────────────────────────┤
│  npx playwright test                                         │
│                                                              │
│  → Делается новый скриншот                                  │
│  → Сравнивается с эталоном                                  │
│  → ✅ Если совпадает → тест пройден                        │
│  → ❌ Если отличается → тест упал                          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  3️⃣ ПРИ ВИЗУАЛЬНЫХ ИЗМЕНЕНИЯХ                              │
├─────────────────────────────────────────────────────────────┤
│  Playwright создает 3 файла:                                │
│  ├── *-actual.png      (новый скриншот)                    │
│  ├── *-expected.png    (эталонный скриншот)                │
│  └── *-diff.png        (визуализация различий)             │
└─────────────────────────────────────────────────────────────┘
```

## 📂 Структура файлов

```
tests/
├── forms.spec.ts
└── forms.spec.ts-snapshots/
    ├── form-complete-result-chromium-darwin.png  ← Эталон заполненной формы
    └── form-empty-result-chromium-darwin.png     ← Эталон пустой формы
```

## 💻 Команды

### Создать/обновить эталонные скриншоты
```bash
npx playwright test --update-snapshots
```

### Запустить тесты с проверкой
```bash
npx playwright test
```

### Запустить только визуальные тесты
```bash
npx playwright test forms.spec.ts
```

### Посмотреть отчет с различиями
```bash
npx playwright show-report
```

## 🔧 Настройки в тестах

```typescript
await expect(element).toHaveScreenshot("название.png", {
  maxDiffPixels: 100,      // Допустимо до 100 отличающихся пикселей
  maxDiffPixelRatio: 0.01, // Или 1% различий
  threshold: 0.2,          // Порог чувствительности (0-1)
});
```

### Параметры:

- **maxDiffPixels** - максимальное количество отличающихся пикселей
- **maxDiffPixelRatio** - максимальный процент отличающихся пикселей (0-1)
- **threshold** - порог чувствительности для определения различия цветов (0-1)

## 🎨 Что проверяется в наших тестах?

### Тест #1: Корректное заполнение формы
```typescript
await expect(formsPage.resultBlock).toHaveScreenshot(
  "form-complete-result.png",
  { maxDiffPixels: 100 }
);
```

**Проверяет:**
- ✅ Зеленый фон блока результата
- ✅ Иконка галочки
- ✅ Текст "Форма отправлена!"
- ✅ JSON с данными пользователя

### Тест #2: Регистрация без заполнения
```typescript
await expect(formsPage.resultBlock).toHaveScreenshot(
  "form-empty-result.png",
  { maxDiffPixels: 100 }
);
```

**Проверяет:**
- ✅ Зеленый фон блока результата
- ✅ Иконка галочки
- ✅ Текст "Форма отправлена!"
- ✅ JSON с пустыми полями

## 🚨 Когда тесты упадут?

Тесты упадут если:
- 🎨 Изменится цвет блока результата
- 📝 Изменится шрифт или размер текста
- 📐 Изменится размер или положение элементов
- 🔤 Изменится текст сообщения
- 🖼️ Изменится любой визуальный аспект

## 🔄 Обновление эталонов

Если визуальные изменения **намеренные** (новый дизайн):

```bash
# Обновить все эталоны
npx playwright test --update-snapshots

# Обновить только для одного теста
npx playwright test forms.spec.ts --update-snapshots
```

## 📊 Преимущества

✅ **Автоматическое обнаружение** визуальных багов  
✅ **Защита от регрессий** в UI  
✅ **Быстрая проверка** верстки после изменений  
✅ **Визуальная документация** ожидаемого результата  
✅ **CI/CD интеграция** - автоматический визуальный контроль

## 🎯 Примеры обнаруженных проблем

Визуальное тестирование поможет обнаружить:
- Сломанную верстку после обновления CSS
- Неправильные цвета после рефакторинга
- Смещенные элементы
- Неправильные шрифты
- Проблемы с отступами и размерами

## 📚 Дополнительная информация

- [Playwright Visual Comparisons](https://playwright.dev/docs/test-snapshots)
- [Best Practices](https://playwright.dev/docs/best-practices#visual-comparisons)

---

**Создано:** 2026-01-13  
**Автор:** QA Automation Team
